/*********************************************************************
*
*   MODULE NAME:
*       NVM_main.c
*
*   DESCRIPTION:
*       Manages writing and reading from flash.
*
* Copyright 2015 by Garmin Ltd. or its subsidiaries.
*********************************************************************/

/*--------------------------------------------------------------------
                           GENERAL INCLUDES
--------------------------------------------------------------------*/

#include <string.h>
#include "NVM_pub.h"
#include "IOP_pub.h"

/*--------------------------------------------------------------------
                          LITERAL CONSTANTS
--------------------------------------------------------------------*/

#define FLASH_OFFSET    0x7F00

/*--------------------------------------------------------------------
                                TYPES
--------------------------------------------------------------------*/

/*--------------------------------------------------------------------
                           PROJECT INCLUDES
--------------------------------------------------------------------*/

#include "iap.h"
#include "iap_driver.h"

/*--------------------------------------------------------------------
                           MEMORY CONSTANTS
--------------------------------------------------------------------*/

/*--------------------------------------------------------------------
                              VARIABLES
--------------------------------------------------------------------*/

NVM_nonvol_type NVM_nonvol_ram;

/*--------------------------------------------------------------------
                                MACROS
--------------------------------------------------------------------*/

/*--------------------------------------------------------------------
                              PROCEDURES
--------------------------------------------------------------------*/

/*********************************************************************
*
*   PROCEDURE NAME:
*       NVM_pwrp - Powerup
*
*   DESCRIPTION:
*       Powerup the NVM module.
*
*********************************************************************/
void NVM_pwrp
    (
    void
    )
{

iap_init();

memcpy(&NVM_nonvol_ram, (void *)FLASH_OFFSET, sizeof( NVM_nonvol_type ) );

if( NVM_nonvol_ram.NVM_valid != NVM_VALID )
    {
    memcpy(&NVM_nonvol_ram, &my_nonvol_defaults, sizeof( NVM_nonvol_type ) );
    }

} /* NVM_pwrp() */

/*********************************************************************
*
*   PROCEDURE NAME:
*       NVM_inst_nonvol - Instrument nonvol
*
*   DESCRIPTION:
*       Send all of nonvol.
*
*********************************************************************/
void NVM_inst_nonvol
    (
    void
    )
{
IOP_inst(IOP_NVOL_DATA, (uint8 const *)&NVM_nonvol_ram, sizeof(NVM_nonvol_ram));
} /* NVM_inst_nonvol() */

/****************************************************************************
*
*   PROCEDURE NAME:
*		NVM_write
*
*   DESCRIPTION:
*
*   NOTES:
*
****************************************************************************/
void NVM_write
    (
    void
    )
{

iap_nvm_erase(FLASH_OFFSET);
iap_nvm_write(&NVM_nonvol_ram, FLASH_OFFSET);

}	/* NVM_write() */
